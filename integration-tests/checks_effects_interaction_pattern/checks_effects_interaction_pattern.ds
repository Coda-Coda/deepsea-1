object signature UnderSig = {
    doTransfer : unit -> unit;
    doTransferReturn42 : unit -> int
}

object Under : UnderSig {
    let doTransfer () =
        transferEth(msg_sender, msg_value);
        ()
    
    let doTransferReturn42 () =
        transferEth(msg_sender, msg_value);
        42
}

object signature CEIPDemo = {
    test1 : unit -> unit;
    test2 : unit -> unit;
    test3 : unit -> unit;
    ifTest : bool -> unit;
    forTest : unit -> unit;
    layerTest1 : unit -> unit;
    layerTest2 : unit -> unit;
    layerTest3 : unit -> unit
}

(* Note that this only tests a handful of situations
   where the Checks-Effects-Interactions pattern _is_
   followed, not when it it is not followed. *)

object Above (Under_object : UnderSig ) : CEIPDemo {
    let _val : int := 0
    
    let test1 () =
        _val := 42;
        transferEth(msg_sender, msg_value)
        
    
    let test2 () =
        let val = _val in
        transferEth(msg_sender, msg_value)
    
    let test3 () =
        let balBefore = balance(this_address) in
        transferEth(msg_sender, msg_value);
        let balBefore' = balBefore in
        ()
  
    let ifTest b =
        let bal = self_balance in
            if b then
                transferEth(msg_sender, msg_value)
            else
                if !b then
                    transferEth(msg_sender, msg_value)
                else
                    transferEth(msg_sender, msg_value);
            ()

    let forTest () =
        for i = (int) balance(msg_sender) to 42 do
        begin
            ()
        end;
        transferEth(msg_sender, msg_value);
        for i = 0 to 42 do
        begin
            ()
        end;
        ()

    let layerTest1 () = 
        (* When uncommented, the function below should cause verify_checks_effects_interactions_pattern to fail on it. *)
        (*
        Under_object.doTransfer();
        Under_object.doTransfer();
        *)
        ()

    let layerTest2 () =
        (* When uncommented, the function below should cause verify_checks_effects_interactions_pattern to fail on it. *)
        (*
        let x = Under_object.doTransferReturn42() in
        _val := 0;
        *)
        ()

    let layerTest3 () =
        (* When uncommented, the function below should cause verify_checks_effects_interactions_pattern to fail on it. *)
        (*
        let y = 42 in
        let x = Under_object.doTransferReturn42() in
        _val := 0;
        *)
        ()
}


layer signature UnderLayerSig = {
  Under_object : { }
}

layer UNDER : [{}] UnderLayerSig = {
  Under_object = Under
}

layer ABOVE : [ {Under_object : UnderSig} ]  {above : CEIPDemo}  = {
    above = Above
}

layer CONTRACT = ABOVE @ UNDER
